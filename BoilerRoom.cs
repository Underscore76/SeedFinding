using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Net.Mime;
using System.Threading.Tasks;
using SeedFinding.Bundles;
using SeedFinding.Cart;
using SeedFinding.Locations;
using SeedFinding.Trash;

namespace SeedFinding
{
    public class BoilerRoom
    {
        // defining the specific bundles needed
        public const ulong DesiredBundles = (
                // crafts
                // boiler
                CompressedFlags.BOILER_BLACKSMITH
                | CompressedFlags.BOILER_ENGINEER
                | CompressedFlags.BOILER_ADVENTURER
                | CompressedFlags.BOILER_ADVENTURER_SOLAR_ESSENCE
                | CompressedFlags.BOILER_ADVENTURER_VOID_ESSENCE
            );


        static bool ValidSeed(int gameId, bool curate = false)
        {

            if (!RemixedBundles.Generate(gameId).Satisfies(DesiredBundles))
            {
                return false;
            }

            List<int> days = new List<int> {5,7,12,14,19,21,26,28 };
            HashSet<string> allItems = new HashSet<string>();
            List<int> count = new List<int>();
            Dictionary<int,HashSet<string>> dict = new Dictionary<int,HashSet<string>>();
            for (int day = 2; day < 32; day++) {
                HashSet<string> stockIds = new HashSet<string>();
                if (days.Contains(day))
                {
                    var stock = TravelingCart.GetStock(gameId, day);
                    stockIds.UnionWith(new HashSet<string>(stock.Select(o => o.Id.ToString())));
                }
                HashSet<string> trashItems = Trash.Trash.getAllTrash(gameId, day, 0.1, hasFurnace: true);
                if (stockIds.Intersect<string>(RequiredItems).Count() > 0 || trashItems.Intersect<string>(RequiredItems).Count() > 0)
                {
                    count.Add(day);
                    allItems.UnionWith(stockIds);
                    allItems.UnionWith(trashItems);
                    HashSet<string> dayItems = new HashSet<string>();
                    dayItems.UnionWith(stockIds);
                    dayItems.UnionWith(trashItems);
                    dict.Add(day, dayItems);
                }
            }

            if (!allItems.Contains("386") && allItems.Contains("749"))
            {
                for (int geode = 1; geode < 10; geode++)
                {
                    (int,int) item = Mines.GetGeodeContents(gameId, geode, Geode.OmniGeode);
                    if (item.Item1 == 386)
                    {
                        allItems.Add("386");
                        break;
                    }
                }
            }

            if (!RequiredItems.IsSubsetOf(allItems))
            {
                return false;
            }
            if (count.Count() > 5)
            {
                return false;
            }
            if (curate)
            {
                string output = "";
                foreach (var item in dict)
                {
                    output += item.Key + ": [" + String.Join(",", item.Value.Where(i => RequiredItems.Contains(i)).ToArray()) + "];";
                }
                Console.WriteLine($"{gameId};{output}");
            }


            return true;
        }
        static HashSet<string> RequiredItems = new HashSet<string>()
        {
            "334",//": "Copper Bar

            "335",//": "Iron Bar

            "336",//": "Gold Bar

            "768",//": "Solar Essence

            "769",//": "Void Essence

            "338",//": "Refined Quartz

            "787",//": "Battery Pack

            "386"//: "Iridium Ore
        };

       

       
        // single search
        public static void Curate()
        {
            List<int> seeds = new List<int> { 14773,1185652,1850859,2456836,4085978,8500061,9240134,11365158,13539927,14492892,15869914,16068741,16899186,17736181,19076328,19378470,27961619,32102114,33566207,34198695,34203809,36553473,41986664,42090956,44184462,44499285,44530938,46622785,47466953,47778789,51606341,52602389,53832205,56910905,57349914,59319517,60300528,61191303,63717123,68193983,72955708,73380265,74364340,75736612,75790423,77740912,79235859,80209043,81865433,82214308,84035062,84287988,85015736,85388945,86549552,87950904,89359082,90364074,90693237,92511656,93207032,93278971,93475661,97894924,100148125,100653356,101156629,102286486,103638323,104257049,105461285,105864790,110074375,113407344,117920161,118875632,119145197,119664846,120139620,120344562,120405316,122111450,123825459,124896184,130224306,133975144,135554849,136613253,137227685,139524211,141396026,144460015,146359448,146927303,147884131,153076896,154826789,155539296,156517507,156941477,157885743,158641233,159462898,159547788,161620818,161706062,161837950,161928349,162762116,164505349,165399413,166821898,166911645,171305209,172256879,173238773,174217583,174308041,175245151,175245158,175506708,177279550,178428018,179306967,180114738,182356365,184027854,185926384,192376893,192455000,194544193,195828766,196557064,209817646,212003469,213529915,218359679,221892233,224364578,226119248,228083074,228521136,230890845,231805938,231850097,233764637,235935624,237219004,238660949,242624014,244771348,248518655,248576731,250210003,254699205,254995273,255266217,256904350,257256198,257879052,258908360,259416646,260487269,261728465,261846878,264365436,268153016,268527307,269591097,272923885,273538441,279035866,280767518,281850401,283240994,283700790,284930429,285932040,287408801,288490877,288786222,290503976,292043495,292471238,292932152,293399259,293829638,294028030,294940187,295571370,296912175,299350046,306824772,309163015,310372227,312901885,316259403,316815471,317965717,319603952,322846354,324494792,324532755,324571360,327386545,327937133,328541933,328696627,328786299,330236963,331325681,336029868,336254077,336510776,339817213,342609895,342680165,346613787,348002907,349740655,353995493,355538706,356041508,359724142,362544369,363145551,363989639,364560501,365016666,366903131,367288823,369067843,371897294,378411616,382142696,383175107,384417106,384611875,386824996,391087527,391989149,392695329,393066931,394312451,394927086,395304306,397369297,398310869,398547940,399231201,399865884,400119053,404189753,407245887,411624199,415319965,415378055,419204469,420441630,421812234,426762049,429484379,429935875,431461163,433587710,434542635,434698928,436245620,436370324,437796808,438978384,441467175,442832802,446692854,446861148,446995781,448446224,448674811,451089266,451601407,453030822,453776435,455119143,455449270,455551572,456704608,458892023,460390429,462853136,469416497,470268039,470975546,472745548,472939636,473808309,477036599,487397918,492686081,494169211,495842697,496963402,497711500,498151728,499082989,500124658,501121800,501637620,503405063,505389097,506611168,508922084,511913698,512140635,516992740,519137299,519952869,520835495,521594657,523428078,526313565,529928947,531920984,532992481,534601546,537554991,537741603,539653618,540973958,540988106,542715559,543835417,544712232,547855220,550427388,552005282,554062626,558662584,560218032,562508645,566854470,567639456,567733142,568502899,569341423,570249343,570395834,572115393,572326867,572646160,576307970,577528436,581435106,584029435,585058141,585592809,586539686,587609260,588286053,589139501,589172977,595210861,597459012,598841868,600913444,604656073,604911000,607643660,611302290,612964709,614030309,614398968,615586468,617495886,619765258,620205570,620807581,625410062,626102204,626257718,627514323,627654308,630483070,633631973,633663248,634649977,637433155,640982002,641460245,642859326,644134118,646143274,646177172,647060542,648276925,648519426,650792574,651859370,655254912,656277522,656329541,656717829,657549947,658337119,661472521,662418531,663440639,664243396,665165609,665959045,672938770,679205448,679840743,682211227,688449350,693782741,694288380,698219779,700385356,703110534,706412916,709618238,709866706,710075271,711192444,713854050,715035085,717687544,719496568,721935967,723330116,723409246,724122641,726003486,727620582,730933501,731519803,732555984,737780665,737923930,738821535,738980285,740753415,743463880,747266086,749826880,749879699,753978042,755539779,756168250,759349870,762131334,763299467,764791290,766293193,766769964,766835350,767773359,769325236,772737799,773466998,774026379,775350598,775743538,776317537,776998200,779662768,783335232,783898661,784044454,785712319,785931226,786481769,787285353,789649423,791101999,791415237,792877505,793692982,793958092,794038247,794755464,795829569,796295471,798818569,798960741,799419797,799700521,805452327,807467746,808510088,808749837,808979698,810225697,810463415,810553613,816230671,816700735,819238229,821747908,822983481,824528514,825038041,826636628,827489490,828250868,831324745,831380344,833000520,834283071,834703493,835204391,835924142,839977397,839986132,840424350,842346414,849971084,850101885,850767132,853564166,857036280,861735663,862503598,865846784,870054140,870500453,870502918,873526920,874835969,878817634,883456879,883557786,889066357,889818510,890569081,891535052,892230196,892784476,893120849,895428228,896288391,898932444,899340879,901418973,902460704,903140302,904623860,910691253,911174425,913219520,913631977,918793105,919321572,919927278,922054050,924110680,924220190,924730748,927438624,928485478,928526003,928656960,929928105,930696098,931013361,932824328,935252196,939381297,940803693,943787074,946068870,947038522,947627114,948411199,948430863,952325413,954565089,954735236,955988815,957247626,960257884,961232752,966724106,972637611,974246126,976599923,979713415,981013791,983404511,987052920,990285536,991109485,994234701,994357697,996094690,996589630,998629158,1001227485,1001422832,1004203150,1005904009,1010326805,1013559017,1017951671,1020570951,1022422493,1025871697,1030983262,1031490074,1033579574,1034556845,1039362584,1039597392,1039617021,1042847215,1043626635,1045119187,1051341688,1052138735,1053719967,1061618907,1064556297,1068721805,1069358757,1074491668,1074585522,1075461649,1080253540,1081440560,1086391891,1087327641,1088925945,1090211619,1090602401,1092423794,1096457724,1097423576,1097733855,1099019590,1103042403,1105814163,1105874897,1110694716,1114210407,1114485586,1119851407,1121499177,1127299911,1127493750,1127748055,1129107843,1130529471,1131615259,1132061914,1133899247,1134982307,1137955232,1138106214,1138739919,1141311148,1145823148,1146175892,1149690341,1151429158,1151736394,1152982482,1154372699,1155182860,1157878097,1161297069,1162455342,1162950286,1169699005,1178887344,1181480621,1181825799,1184830675,1187083779,1194455584,1195290709,1198310194,1201294693,1202284353,1202916383,1203612337,1207330249,1208615603,1210515407,1211751168,1212651930,1215667201,1217430816,1219613858,1221870626,1223347510,1224903573,1225695451,1226628605,1230045778,1230083808,1230365877,1233496263,1238828934,1241603435,1243299596,1245446849,1247905564,1248173723,1252692799,1254217586,1255901220,1259351107,1266137179,1267703202,1270270159,1271559841,1274187965,1274782464,1275032614,1276133259,1276353357,1280246653,1280537247,1280699429,1281355348,1281559659,1284456560,1284656720,1287595752,1288421494,1288487062,1290642408,1293776004,1294559140,1297742334,1300813240,1302712063,1303050047,1303330190,1305573716,1306251297,1307538928,1309978194,1312723731,1313248276,1314226911,1317113235,1320203433,1321572503,1324556630,1328788637,1329590332,1329948180,1330312357,1333278115,1334910482,1335163747,1337097475,1337990175,1338374229,1338386206,1339561163,1340883633,1341576388,1343630320,1345856991,1347932804,1350349699,1351748153,1351789752,1352234439,1353499034,1355432264,1355592358,1357115434,1361273977,1364478919,1368225694,1370900648,1376366858,1377715151,1377845634,1379713182,1380886939,1383401560,1388487396,1389866497,1389998982,1391028074,1393339575,1394833919,1395732417,1395758484,1396480402,1397017314,1397018691,1399719523,1400473345,1401483855,1407606623,1408432648,1408759114,1416089309,1420242098,1423395032,1423834504,1433370842,1441698862,1442210961,1444476140,1444571813,1444909929,1446514901,1448586827,1449341436,1449913023,1456049018,1456475201,1457738985,1459990944,1464725302,1464771167,1464828928,1466806051,1467776294,1470643065,1473896276,1474962065,1476716973,1477078527,1478678238,1480313831,1485760589,1485965325,1487205542,1490903411,1491803888,1495303536,1498161437,1498735883,1498840032,1499258590,1499516780,1500323264,1503551509,1507372421,1507484022,1512606681,1513817382,1516290266,1519848804,1524068905,1525105189,1525278180,1525895911,1531461987,1532197589,1532242551,1532599484,1533820199,1535398858,1537676891,1541112111,1541806876,1549473619,1553569158,1561557066,1561644546,1562941675,1570951326,1570986325,1571904989,1574236534,1574330156,1574710823,1576621116,1578141594,1578442013,1582944365,1586107710,1587837422,1588213534,1596926127,1601180769,1601642753,1602237304,1602406513,1604266955,1605137566,1605917600,1607726531,1611334478,1612049394,1612230047,1612982269,1614299532,1615202582,1615382437,1616392431,1617504419,1619337718,1621769726,1621883576,1621985424,1628778625,1630447420,1634651453,1642472502,1642579841,1646609545,1647615021,1652429267,1653783264,1655255031,1657508636,1658239293,1661821768,1663663696,1665716937,1665825514,1668259053,1668429476,1668733944,1670674430,1672622085,1674469810,1674655163,1674910006,1675312398,1677853710,1678970177,1679945965,1681015676,1681580829,1681889000,1688044812,1693972548,1695272559,1699576922,1703371581,1705721799,1708043674,1709631649,1713077690,1714215866,1716406134,1717472275,1719454711,1720879615,1721403208,1730064636,1731135415,1732246266,1732457796,1733146147,1733278720,1733530531,1734762830,1736577666,1737058433,1738100895,1738460424,1739102598,1741856859,1742345687,1742763532,1743684123,1744043979,1744115884,1744995126,1746678258,1748152099,1751527794,1751559534,1751947953,1752331924,1752894272,1753064668,1760805348,1761694541,1762279818,1764251795,1767545886,1767859995,1772634631,1775925595,1776778300,1777666829,1780635324,1785073317,1789472081,1790111406,1795135002,1795387393,1796274812,1796363360,1797905882,1798822988,1802922809,1803359406,1803895211,1804648829,1807118060,1809156632,1811078061,1813776245,1819226899,1820267681,1820508337,1822028058,1822353893,1822768535,1827587065,1829554329,1829978335,1830565466,1832039804,1835161527,1836217651,1836331934,1836916041,1838096059,1838701217,1839214371,1839569612,1839879885,1845277210,1846419686,1846709094,1849712260,1853739097,1855650459,1860470945,1861303733,1862742490,1863485735,1864202472,1865475555,1865862661,1870996646,1871273778,1876341394,1876495371,1877138751,1881074686,1886477657,1887622973,1887969347,1891075114,1891137735,1891614147,1892778361,1895443479,1897380387,1898701993,1900017798,1902319944,1903364078,1904425453,1906221214,1907700696,1908656545,1908767561,1908937414,1910356856,1913822019,1917899825,1921085397,1921978693,1929752717,1933352118,1935483366,1935608691,1937226720,1937627542,1940617044,1940968182,1941651433,1942891432,1946638284,1948506542,1950125177,1950988159,1953515154,1953953164,1955741717,1964924713,1965777592,1966546386,1968912418,1969050564,1969623610,1972822539,1973928313,1975986275,1976676883,1976772705,1977971680,1978351140,1978612915,1980561670,1984131153,1991058665,1991726228,1991964395,1992057045,1992185348,1993290283,1993557367,1997436546,1998344099,1999731802,2000817790,2000961119,2001754209,2002858090,2005288771,2005357035,2009124037,2009132070,2010420220,2011011428,2012085211,2012458084,2014063595,2014542627,2016093148,2017715795,2023584497,2025902634,2026341708,2026632197,2027499201,2028960041,2029475572,2031403221,2033524192,2034312705,2035500070,2035981260,2040175876,2042460651,2043844086,2045382177,2047271601,2047505607,2051970097,2053095138,2055461414,2058506157,2058828216,2062671129,2065745866,2066109622,2066124387,2066236735,2066903016,2068925734,2069951783,2073210536,2074379966,2079228658,2081983947,2088469239,2090373815,2093121631,2095762099,2101754161,2103500156,2107579885,2108508980,2108566514,2112858318,2113015346,2115687969,2119390578,2120211280,2123158063,2123948845,2124376048,2127353916,2127402563,2130865137,2132025778,2133771917,2137695505,2139152865,2139797827,2143558584,2146843697,2146858599
            };

            foreach (var seed in seeds)
            {
                ValidSeed(seed, true);
            }
        }

        // parallel search
        public static double Search(int numSeeds, int blockSize, out List<int> validSeeds)
        {
            Stopwatch stopwatch = Stopwatch.StartNew();
            var bag = new ConcurrentBag<int>();
            var partioner = Partitioner.Create(0, numSeeds, blockSize);
            Parallel.ForEach(partioner, (range, loopState) =>
            {
                for (int seed = range.Item1; seed < range.Item2; seed++)
                {
                    if (ValidSeed(seed))
                    {
                        bag.Add(seed);

                        Console.WriteLine(seed);
                    }
                }
            });
            double seconds = stopwatch.Elapsed.TotalSeconds;
            Console.WriteLine($"Found: {bag.Count} sols in {seconds.ToString("F2")} s");
            validSeeds = bag.ToList();
            validSeeds.Sort();
            return seconds;
        }
    }
}


